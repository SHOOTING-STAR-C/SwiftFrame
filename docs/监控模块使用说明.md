# SwiftFrame ç›‘æ§æ¨¡å—ä½¿ç”¨è¯´æ˜

## ğŸ“Š æ¨¡å—æ¦‚è¿°

`swift-monitor` æ˜¯ SwiftFrame æ¡†æ¶çš„ç³»ç»Ÿç›‘æ§æ¨¡å—ï¼ŒåŸºäº Spring Boot Actuator å’Œ Micrometer æ„å»ºï¼Œæä¾›å…¨é¢çš„åº”ç”¨å¥åº·æ£€æŸ¥å’Œæ€§èƒ½ç›‘æ§èƒ½åŠ›ã€‚

## ğŸ¯ æ ¸å¿ƒåŠŸèƒ½

### 1. å¥åº·æ£€æŸ¥ (Health)
ç›‘æ§åº”ç”¨åŠå„ç»„ä»¶çš„å¥åº·çŠ¶æ€ï¼š
- âœ… åº”ç”¨æ•´ä½“å¥åº·çŠ¶æ€
- âœ… æ•°æ®åº“è¿æ¥çŠ¶æ€
- âœ… Redis è¿æ¥çŠ¶æ€
- âœ… ç£ç›˜ç©ºé—´æ£€æŸ¥
- âœ… JVM å†…å­˜ä½¿ç”¨æƒ…å†µ
- âœ… ç³»ç»Ÿè¿è¡ŒçŠ¶æ€

### 2. æ€§èƒ½æŒ‡æ ‡ (Metrics)
æ”¶é›†å’Œå¯¼å‡ºåº”ç”¨æ€§èƒ½æŒ‡æ ‡ï¼š
- HTTP è¯·æ±‚ç»Ÿè®¡ï¼ˆå“åº”æ—¶é—´ã€è¯·æ±‚æ•°é‡ï¼‰
- JVM å†…å­˜æŒ‡æ ‡
- çº¿ç¨‹æ± çŠ¶æ€
- æ•°æ®åº“è¿æ¥æ± çŠ¶æ€
- è‡ªå®šä¹‰ä¸šåŠ¡æŒ‡æ ‡

### 3. ç³»ç»Ÿä¿¡æ¯
æŸ¥çœ‹åº”ç”¨è¿è¡Œç¯å¢ƒä¿¡æ¯ï¼š
- åº”ç”¨é…ç½®ä¿¡æ¯
- ç³»ç»Ÿç¯å¢ƒå˜é‡
- æ—¥å¿—é…ç½®
- çº¿ç¨‹å †æ ˆä¿¡æ¯

## ğŸ”§ é…ç½®è¯´æ˜

### åŸºç¡€é…ç½®

ç›‘æ§æ¨¡å—åœ¨ `application.yml` ä¸­å·²é¢„é…ç½®ï¼š

```yaml
# Actuator ç›‘æ§é…ç½®
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus,env,loggers,threaddump,heapdump
      base-path: /actuator
  endpoint:
    health:
      show-details: always
      show-components: always
      probes:
        enabled: true
    metrics:
      enabled: true
    prometheus:
      enabled: true
  metrics:
    export:
      prometheus:
        enabled: true
    tags:
      application: ${app.name:SWIFT}
      env: @build.profile.id@
    distribution:
      percentiles-histogram:
        http.server.requests: true
      percentiles:
        http.server.requests: 0.5,0.95,0.99
  health:
    redis:
      enabled: true
    db:
      enabled: true
    diskspace:
      enabled: true
      threshold: 10MB

swift:
  monitor:
    enabled: true  # å¯ç”¨ç›‘æ§æ¨¡å—
```

### å¯ç”¨/ç¦ç”¨ç›‘æ§

é€šè¿‡é…ç½®æ§åˆ¶ç›‘æ§æ¨¡å—çš„å¯ç”¨çŠ¶æ€ï¼š

```yaml
swift:
  monitor:
    enabled: false  # ç¦ç”¨ç›‘æ§æ¨¡å—
```

## ğŸ“¡ ç›‘æ§ç«¯ç‚¹

### âš ï¸ å®‰å…¨æç¤º

**ç›‘æ§ç«¯ç‚¹åŒ…å«æ•æ„Ÿçš„ç³»ç»Ÿä¿¡æ¯ï¼Œéœ€è¦è®¤è¯è®¿é—®ã€‚**

æ‰€æœ‰ç›‘æ§ç«¯ç‚¹éƒ½éœ€è¦ç™»å½•åæ‰èƒ½è®¿é—®ï¼Œæœªè®¤è¯ç”¨æˆ·æ— æ³•æŸ¥çœ‹ç›‘æ§æ•°æ®ã€‚

### å¯ç”¨ç«¯ç‚¹åˆ—è¡¨

| ç«¯ç‚¹ | è¯´æ˜ | è®¿é—®æ–¹å¼ |
|------|------|----------|
| `/actuator/health` | åº”ç”¨å¥åº·çŠ¶æ€ | GET |
| `/actuator/health/swiftSystem` | è‡ªå®šä¹‰ç³»ç»Ÿå¥åº·æ£€æŸ¥ | GET |
| `/actuator/info` | åº”ç”¨ä¿¡æ¯ | GET |
| `/actuator/metrics` | æ‰€æœ‰å¯ç”¨æŒ‡æ ‡ | GET |
| `/actuator/metrics/{metric.name}` | ç‰¹å®šæŒ‡æ ‡è¯¦æƒ… | GET |
| `/actuator/prometheus` | Prometheus æ ¼å¼æŒ‡æ ‡ | GET |
| `/actuator/env` | ç¯å¢ƒé…ç½®ä¿¡æ¯ | GET |
| `/actuator/loggers` | æ—¥å¿—é…ç½® | GET/POST |
| `/actuator/threaddump` | çº¿ç¨‹å †æ ˆä¿¡æ¯ | GET |
| `/actuator/heapdump` | JVM å †å†…å­˜å¿«ç…§ | GET |

### è®¿é—®ç¤ºä¾‹

#### 1. å¥åº·æ£€æŸ¥

```bash
# éœ€è¦åœ¨è¯·æ±‚å¤´ä¸­æºå¸¦æœ‰æ•ˆçš„ JWT Token
curl -H "Authorization: Bearer <your-jwt-token>" \
  http://localhost:8081/swift/actuator/health
```

å“åº”ç¤ºä¾‹ï¼š

```json
{
  "status": "UP",
  "components": {
    "db": {
      "status": "UP",
      "details": {
        "database": "MySQL",
        "validationQuery": "isValid()"
      }
    },
    "diskSpace": {
      "status": "UP",
      "details": {
        "total": 499963174912,
        "free": 31727472640,
        "path": "E:\\.",
        "threshold": 10485760
      }
    },
    "ping": {
      "status": "UP"
    },
    "redis": {
      "status": "UP",
      "details": {
        "version": "7.0.15"
      }
    },
    "swiftSystem": {
      "status": "UP",
      "details": {
        "heapMemory": {
          "used": "123.45 MB",
          "max": "512.00 MB",
          "percent": "24.11%"
        },
        "nonHeapMemory": {
          "used": "45.67 MB",
          "max": "768.00 MB",
          "percent": "5.95%"
        },
        "operatingSystem": {
          "processors": 8,
          "name": "Windows 10",
          "version": "10.0",
          "arch": "amd64"
        },
        "jvm": {
          "name": "OpenJDK 64-Bit Server VM",
          "version": "21.0.1",
          "vendor": "Oracle Corporation",
          "uptime": "1å°æ—¶ 23åˆ†é’Ÿ"
        }
      }
    }
  }
}
```

#### 2. æŸ¥çœ‹æ‰€æœ‰æŒ‡æ ‡

```bash
curl -H "Authorization: Bearer <your-jwt-token>" \
  http://localhost:8081/swift/actuator/metrics
```

#### 3. æŸ¥çœ‹ç‰¹å®šæŒ‡æ ‡

```bash
# æŸ¥çœ‹ HTTP è¯·æ±‚æŒ‡æ ‡
curl -H "Authorization: Bearer <your-jwt-token>" \
  http://localhost:8081/swift/actuator/metrics/http.server.requests

# æŸ¥çœ‹ JVM å†…å­˜æŒ‡æ ‡
curl -H "Authorization: Bearer <your-jwt-token>" \
  http://localhost:8081/swift/actuator/metrics/jvm.memory.used
```

#### 4. Prometheus æŒ‡æ ‡å¯¼å‡º

```bash
curl -H "Authorization: Bearer <your-jwt-token>" \
  http://localhost:8081/swift/actuator/prometheus
```

æ­¤ç«¯ç‚¹è¿”å› Prometheus æ ¼å¼çš„æŒ‡æ ‡æ•°æ®ï¼Œå¯ç”¨äºé›†æˆåˆ° Prometheus + Grafana ç›‘æ§ç³»ç»Ÿã€‚

## ğŸ” è®¿é—®æ§åˆ¶

### è®¤è¯æ–¹å¼

ç›‘æ§ç«¯ç‚¹ä½¿ç”¨ä¸ä¸šåŠ¡æ¥å£ç›¸åŒçš„ JWT è®¤è¯æœºåˆ¶ï¼š

1. **ç™»å½•è·å– Token**
   ```bash
   curl -X POST http://localhost:8081/swift/auth/login \
     -H "Content-Type: application/json" \
     -d '{"username":"admin","password":"your-password"}'
   ```

2. **ä½¿ç”¨ Token è®¿é—®ç›‘æ§ç«¯ç‚¹**
   ```bash
   curl -H "Authorization: Bearer <your-jwt-token>" \
     http://localhost:8081/swift/actuator/health
   ```

### æƒé™å»ºè®®

å»ºè®®ä¸ºç›‘æ§ç«¯ç‚¹è®¿é—®é…ç½®ç‹¬ç«‹çš„è§’è‰²æƒé™ï¼š

```java
// åœ¨ SecurityConfig ä¸­é…ç½®ç‰¹å®šè§’è‰²è®¿é—®
.authorizeHttpRequests(auth -> auth
    .requestMatchers("/actuator/**").hasRole("ADMIN")
    // ...
)
```

## ğŸ“ˆ é›†æˆå¤–éƒ¨ç›‘æ§ç³»ç»Ÿ

### Prometheus + Grafana

#### 1. é…ç½® Prometheus

åˆ›å»º `prometheus.yml` é…ç½®æ–‡ä»¶ï¼š

```yaml
global:
  scrape_interval: 15s

scrape_configs:
  - job_name: 'swiftframe'
    metrics_path: '/swift/actuator/prometheus'
    # æ·»åŠ è®¤è¯å¤´
    authorization:
      credentials: '<your-jwt-token>'
    static_configs:
      - targets: ['localhost:8081']
```

#### 2. å¯åŠ¨ Prometheus

```bash
docker run -d \
  -p 9090:9090 \
  -v $(pwd)/prometheus.yml:/etc/prometheus/prometheus.yml \
  prom/prometheus
```

#### 3. é…ç½® Grafana

å¯¼å…¥ Spring Boot ä»ªè¡¨æ¿æ¨¡æ¿ï¼š
- æœç´¢ "JVM Micrometer" ä»ªè¡¨æ¿
- å¯¼å…¥ ID: 4701 (JVM (Micrometer))
- é…ç½® Prometheus æ•°æ®æº

## ğŸ¨ è‡ªå®šä¹‰å¥åº·æ£€æŸ¥

### åˆ›å»ºè‡ªå®šä¹‰å¥åº·æŒ‡ç¤ºå™¨

```java
@Component
public class CustomServiceHealthIndicator implements HealthIndicator {
    
    @Override
    public Health health() {
        // è‡ªå®šä¹‰å¥åº·æ£€æŸ¥é€»è¾‘
        boolean isHealthy = checkCustomService();
        
        if (isHealthy) {
            return Health.up()
                .withDetail("service", "custom")
                .withDetail("status", "running")
                .build();
        } else {
            return Health.down()
                .withDetail("error", "Service unavailable")
                .build();
        }
    }
    
    private boolean checkCustomService() {
        // å®ç°æ£€æŸ¥é€»è¾‘
        return true;
    }
}
```

### è®¿é—®è‡ªå®šä¹‰å¥åº·æ£€æŸ¥

```bash
curl -H "Authorization: Bearer <your-jwt-token>" \
  http://localhost:8081/swift/actuator/health/customService
```

## ğŸ“Š è‡ªå®šä¹‰æŒ‡æ ‡

### ä½¿ç”¨ Micrometer è®°å½•æŒ‡æ ‡

```java
@Service
@RequiredArgsConstructor
public class BusinessService {
    
    private final MeterRegistry meterRegistry;
    
    public void processRequest() {
        // è®°å½•ä¸šåŠ¡æŒ‡æ ‡
        meterRegistry.counter("business.requests.total").increment();
        
        // è®°å½•å¤„ç†æ—¶é—´
        Timer.Sample sample = Timer.start(meterRegistry);
        try {
            // ä¸šåŠ¡é€»è¾‘
            doBusiness();
        } finally {
            sample.stop(meterRegistry.timer("business.requests.duration"));
        }
    }
    
    private void doBusiness() {
        // ä¸šåŠ¡å®ç°
    }
}
```

### æŸ¥çœ‹è‡ªå®šä¹‰æŒ‡æ ‡

```bash
curl -H "Authorization: Bearer <your-jwt-token>" \
  http://localhost:8081/swift/actuator/metrics/business.requests.total
```

## ğŸš¨ å‘Šè­¦é…ç½®

### åŸºäºå¥åº·æ£€æŸ¥çš„å‘Šè­¦

åœ¨ Prometheus ä¸­é…ç½®å‘Šè­¦è§„åˆ™ï¼š

```yaml
groups:
  - name: swiftframe_alerts
    rules:
      - alert: ApplicationDown
        expr: up{job="swiftframe"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "åº”ç”¨ {{ $labels.instance }} å®•æœº"
          
      - alert: HighMemoryUsage
        expr: jvm_memory_used_bytes{area="heap"} / jvm_memory_max_bytes{area="heap"} > 0.9
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "å †å†…å­˜ä½¿ç”¨ç‡è¶…è¿‡ 90%"
```

## ğŸ“ æœ€ä½³å®è·µ

### 1. ç›‘æ§ç«¯ç‚¹å®‰å…¨

- âœ… å§‹ç»ˆä¿æŒç›‘æ§ç«¯ç‚¹éœ€è¦è®¤è¯
- âœ… ä½¿ç”¨ HTTPS ä¿æŠ¤ç›‘æ§æ•°æ®ä¼ è¾“
- âœ… å®šæœŸè½®æ¢ç›‘æ§è®¿é—®çš„ JWT Token
- âœ… åœ¨ç”Ÿäº§ç¯å¢ƒä¸­é™åˆ¶ç›‘æ§ç«¯ç‚¹è®¿é—® IP

### 2. æŒ‡æ ‡é‡‡é›†

- âœ… åˆç†è®¾ç½®æŒ‡æ ‡é‡‡é›†é—´éš”ï¼ˆå»ºè®® 15-30 ç§’ï¼‰
- âœ… åªé‡‡é›†å¿…è¦çš„æŒ‡æ ‡ï¼Œé¿å…æ€§èƒ½å½±å“
- âœ… å®šæœŸæ¸…ç†è¿‡æœŸçš„æŒ‡æ ‡æ•°æ®

### 3. å‘Šè­¦ç­–ç•¥

- âœ… è®¾ç½®åˆç†çš„å‘Šè­¦é˜ˆå€¼ï¼Œé¿å…å‘Šè­¦é£æš´
- âœ… åˆ†çº§å‘Šè­¦ï¼ˆcriticalã€warningã€infoï¼‰
- âœ… é…ç½®å‘Šè­¦é€šçŸ¥æ¸ é“ï¼ˆé‚®ä»¶ã€é’‰é’‰ã€ä¼ä¸šå¾®ä¿¡ç­‰ï¼‰

### 4. æ€§èƒ½ä¼˜åŒ–

- âœ… åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼Œå‡å°‘æŒ‡æ ‡é‡‡é›†é¢‘ç‡
- âœ… ä½¿ç”¨å¼‚æ­¥æ–¹å¼è®°å½•æŒ‡æ ‡
- âœ… å®šæœŸåˆ†ææŒ‡æ ‡æ•°æ®ï¼Œä¼˜åŒ–åº”ç”¨æ€§èƒ½

## ğŸ” æ•…éšœæ’æŸ¥

### å¸¸è§é—®é¢˜

#### 1. ç›‘æ§ç«¯ç‚¹æ— æ³•è®¿é—®

**é—®é¢˜**ï¼šè®¿é—®ç›‘æ§ç«¯ç‚¹è¿”å› 401 æˆ– 403

**è§£å†³æ–¹æ¡ˆ**ï¼š
- ç¡®è®¤å·²ç™»å½•å¹¶æºå¸¦æœ‰æ•ˆçš„ JWT Token
- æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å…·æœ‰è®¿é—®ç›‘æ§ç«¯ç‚¹çš„æƒé™
- éªŒè¯ Security é…ç½®æ˜¯å¦æ­£ç¡®

#### 2. å¥åº·æ£€æŸ¥æ˜¾ç¤º DOWN

**é—®é¢˜**ï¼šæŸäº›ç»„ä»¶å¥åº·æ£€æŸ¥å¤±è´¥

**è§£å†³æ–¹æ¡ˆ**ï¼š
- æŸ¥çœ‹å…·ä½“çš„å¥åº·æ£€æŸ¥è¯¦æƒ…
- æ£€æŸ¥æ•°æ®åº“ã€Redis ç­‰ä¾èµ–æœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œ
- ç¡®è®¤ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸

#### 3. æŒ‡æ ‡æ•°æ®ä¸å‡†ç¡®

**é—®é¢˜**ï¼šé‡‡é›†çš„æŒ‡æ ‡æ•°æ®ä¸å®é™…æƒ…å†µä¸ç¬¦

**è§£å†³æ–¹æ¡ˆ**ï¼š
- æ£€æŸ¥æŒ‡æ ‡é‡‡é›†é…ç½®
- ç¡®è®¤ Micrometer é…ç½®æ˜¯å¦æ­£ç¡®
- éªŒè¯è‡ªå®šä¹‰æŒ‡æ ‡çš„å®ç°é€»è¾‘

## ğŸ“š å‚è€ƒèµ„æ–™

- [Spring Boot Actuator å®˜æ–¹æ–‡æ¡£](https://docs.spring.io/spring-boot/docs/current/reference/html/actuator.html)
- [Micrometer å®˜æ–¹æ–‡æ¡£](https://micrometer.io/docs)
- [Prometheus å®˜æ–¹æ–‡æ¡£](https://prometheus.io/docs/)
- [Grafana å®˜æ–¹æ–‡æ¡£](https://grafana.com/docs/)

## ğŸ†˜ æŠ€æœ¯æ”¯æŒ

å¦‚é‡åˆ°é—®é¢˜ï¼Œè¯·ï¼š
1. æŸ¥çœ‹æœ¬æ–‡æ¡£çš„æ•…éšœæ’æŸ¥ç« èŠ‚
2. æ£€æŸ¥åº”ç”¨æ—¥å¿—è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯
3. è®¿é—® [SwiftFrame GitHub](https://github.com/SHOOTING-STAR-C/SwiftFrame) æäº¤ Issue

---

**æ³¨æ„**ï¼šç›‘æ§æ•°æ®åŒ…å«æ•æ„Ÿä¿¡æ¯ï¼Œè¯·å¦¥å–„ä¿ç®¡è®¿é—®å‡­è¯ï¼Œé¿å…æ³„éœ²ã€‚
