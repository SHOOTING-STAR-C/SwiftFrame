# 匿名聊天功能设计说明

## 功能概述

支持未登录用户使用AI聊天功能，并在用户注册后可将匿名聊天记录导入到个人账户。

## 后端接口

### 1. 匿名聊天接口

**接口路径：** `POST /ai/chat/anonymous`

**说明：** 未登录用户使用，不保存任何数据到数据库，仅返回AI回复

**请求参数：**
```json
{
  "modelId": 1,
  "message": "你好，请问你是谁？"
}
```

### 2. 导入聊天记录接口

**接口路径：** `POST /ai/chat/import`

**说明：** 用户注册后调用，将匿名聊天记录导入到数据库

**请求参数：**
```json
{
  "sessions": [
    {
      "sessionId": "uuid字符串",
      "modelId": 1,
      "title": "会话标题",
      "messages": [
        {
          "role": "user",
          "content": "用户消息"
        },
        {
          "role": "assistant",
          "content": "AI回复"
        }
      ]
    }
  ]
}
```

## 前端设计要点

### 1. 数据存储

- **存储位置：** localStorage
- **存储键名：** `anonymous_chat_sessions`
- **数据结构：** 会话列表，每个会话包含sessionId、modelId、title、messages等字段

### 2. 匿名聊天流程

1. 用户未登录时，调用 `/ai/chat/anonymous` 接口
2. 将聊天记录保存到 localStorage
3. sessionId 由前端生成（UUID格式）
4. 不调用任何需要认证的接口

### 3. 注册后导入流程

1. 用户注册成功后，检查 localStorage 中是否有匿名聊天记录
2. 如果有，调用 `/ai/chat/import` 接口上传数据
3. 导入成功后，清除 localStorage 中的数据
4. 刷新会话列表，显示已导入的会话

### 4. 关键设计点

- **sessionId生成：** 前端使用UUID生成器创建唯一会话ID
- **数据同步：** 匿名聊天时，每次调用接口后立即更新localStorage
- **导入时机：** 注册成功后立即导入，确保用户不丢失聊天记录
- **错误处理：** 即使导入失败也不影响用户继续使用，只是匿名记录会丢失
- **用户提示：** 导入成功后给用户明确提示

## 数据模型

### AnonymousSession（匿名会话）
```typescript
{
  sessionId: string,      // 会话ID（UUID）
  modelId: number,        // 模型ID
  title: string,          // 会话标题
  messages: Message[],    // 消息列表
  createdAt: number       // 创建时间戳
}
```

### Message（消息）
```typescript
{
  role: 'user' | 'assistant',
  content: string
}
```

## 注意事项

1. **数据安全：** localStorage中的数据可以被用户清除，这是预期行为
2. **存储限制：** localStorage有大小限制（通常5-10MB），建议限制匿名会话数量
3. **跨设备：** 匿名聊天记录仅存储在当前浏览器，换设备后无法找回
4. **导入去重：** 后端会检查sessionId是否已存在，避免重复导入
5. **用户体验：** 注册成功后应自动导入，无需用户手动操作

## 完整流程

1. **匿名用户访问** → 检测未登录 → 使用匿名聊天接口
2. **匿名聊天** → 调用 `/ai/chat/anonymous` → 数据存localStorage
3. **用户注册** → 注册成功 → 调用 `/ai/chat/import` → 清除localStorage
4. **注册后** → 使用正常聊天接口 `/ai/chat` → 数据存数据库
